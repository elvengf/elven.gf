<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="chatbox.css" />
</head>
<body>
    <div class="chatbox">
        <div class="chatbox-content">
            <div id="chat" class="chat-feed"></div>
        </div>
    </div>

    <!-- tmi.js (Twitch IRC client) -->
    <script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5/dist/tmi.min.js"></script>
    <script>// Read channel from ?channel=YOURNAME (fallback to placeholder)
    const params  = new URLSearchParams(location.search);
    const CHANNEL = (params.get('channel') || 'meatcanyon').trim();

    const client = new tmi.Client({
      connection: { secure: true, reconnect: true },
      identity:   { username: 'justinfan12345', password: 'oauth:anonymous' }, // anonymous
      channels:   [ CHANNEL ]
    });

    const chatEl = document.getElementById('chat');

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, s => (
        { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[s]
      ));
    }

    // Convert Twitch emote ranges to <img>
    function parseEmotes(message, emotes) {
      if (!emotes) return [escapeHtml(message)];

      const ranges = [];
      Object.keys(emotes).forEach(id => {
        emotes[id].forEach(r => {
          const [start, end] = r.split('-').map(Number);
          ranges.push({ id, start, end });
        });
      });
      ranges.sort((a,b) => a.start - b.start);

      const parts = [];
      let last = 0;

      for (const { id, start, end } of ranges) {
        if (last < start) parts.push(escapeHtml(message.slice(last, start)));
        const alt = escapeHtml(message.slice(start, end + 1));
        const url = `https://static-cdn.jtvnw.net/emoticons/v2/${id}/default/dark/1.0`;
        parts.push(`<img src="${url}" alt="${alt}" class="emote">`);
        last = end + 1;
      }
      if (last < message.length) parts.push(escapeHtml(message.slice(last)));
      return parts;
    }

    function addMessage(tags, message) {
      const row = document.createElement('div');
      row.className = 'msg';

      const name = document.createElement('span');
      name.className = 'name';
      if (tags.color) name.style.color = tags.color;
      name.textContent = (tags['display-name'] || tags.username) + ': ';

      const text = document.createElement('span');
      text.className = 'text';
      text.innerHTML = parseEmotes(message, tags.emotes).join('');

      row.appendChild(name);
      row.appendChild(text);
      chatEl.appendChild(row);

      // Trim old messages so it doesn't grow forever
      if (chatEl.children.length > 300) chatEl.removeChild(chatEl.firstChild);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    client.on('message', (channel, tags, message, self) => {
      if (self) return;
      addMessage(tags, message);
    });

    client.connect().catch(console.error);</script>
</body>
</html>
